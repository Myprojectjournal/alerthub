<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Optional: Content Security Policy for API calls -->
  <meta http-equiv="Content-Security-Policy" 
        content="default-src * 'self' data: gap: https://reportapp.infinityfree.me; 
                 style-src 'self' 'unsafe-inline'; 
                 script-src 'self' 'unsafe-inline' 'unsafe-eval';">

  <title>Citizen Report App</title>
 
<link rel="stylesheet" href="css/style.css">
</head>
<body>

<header>
    <h1>AlertHub</h1>
</header>

<div class="mobile-buttons">
    <button onclick="window.location.href='submit.html'">Submit</button>
    <button onclick="logout()">Logout</button>
</div>

<div class="wrapper">

    <div class="left-panel">
        <button onclick="window.location.href='submit.html'">Report Incident</button>
        <button onclick="logout()">Logout</button>
    </div>

    <div class="container">
        <div class="filter-wrapper">
            <label for="category">Filter by Category:</label>
            <select id="category">
                <option value="all">All</option>
                <option value="Accident">Accident</option>
                <option value="Fighting">Fighting</option>
                <option value="Rioting">Rioting</option>
            </select>
        </div>

        <div id="incidentList"></div>
    </div>
</div>
<script src="cordova.js"></script>
<script src="js/location.js"></script>

<!-- Only the incident loading JS part changed -->
<script>
document.addEventListener("deviceready", () => {}, false);

const token = localStorage.getItem("jwtToken");
if (!token) window.location.href = "loginpage.html";

// Logout function
function logout() {
    localStorage.clear();
    window.location.href = "loginpage.html";
}

// Start a fresh incident (new submit)
function startNewIncident() {
    localStorage.removeItem("editPostId"); // clear edit flag
    window.location.href = "submit.html";
}

// Attach startNewIncident to all Submit / Report Incident buttons
document.querySelectorAll(".mobile-buttons button, .left-panel button").forEach(btn => {
    const text = btn.textContent.trim();
    if (text === "Submit" || text === "Report Incident") {
        btn.onclick = startNewIncident;
    }
});

// Edit incident function
function editIncident(postId) {
    localStorage.setItem("editPostId", postId);
    window.location.href = "submit.html";
}

// Delete incident function
async function deleteIncident(postId) {
    if (!confirm("Are you sure you want to delete this incident?")) return;

    try {
        const res = await fetch(`https://reportapp.infinityfree.me/wp-json/wp/v2/posts/${postId}`, {
            method: "DELETE",
            headers: {
                "Authorization": "Bearer " + token
            }
        });

        const data = await res.json();
        if (res.ok) {
            // Remove from DOM
            const div = document.getElementById(`incident-${postId}`);
            if (div) div.remove();
            alert("Incident deleted successfully!");
        } else {
            console.error(data);
            alert("Failed to delete incident. Check console.");
        }
    } catch (err) {
        console.error(err);
        alert("Error deleting incident");
    }
}


// Mapping categories to IDs
const categoryMap = { Accident: 2, Fighting: 3, Rioting: 4 };

// Load incidents from WordPress
async function loadIncidents() {
    try {
        const category = document.getElementById("category").value;

        const res = await fetch(
            "https://reportapp.infinityfree.me/wp-json/wp/v2/posts?per_page=50&_embed",
            { headers: { Authorization: "Bearer " + token } }
        );
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const data = await res.json();

        // Filter by category
        let filtered = category === "all" ? data : data.filter(p => p.categories.includes(categoryMap[category]));
        filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

        const list = document.getElementById("incidentList");
        list.innerHTML = "";

        filtered.forEach(post => {
            const img = post._embedded?.["wp:featuredmedia"]?.[0]?.source_url || "";

            // Extract location from content
            let locationText = '';
            let description = post.content.rendered;
            const locationMatch = description.match(/<b>Location:<\/b>\s*([^<]*)<\/p>/i);
if (locationMatch) {
    locationText = locationMatch[1].trim();
    description = description.replace(locationMatch[0], '');
}

            description = description.replace(/<[^>]+>/g, '').trim();

            const div = document.createElement("div");
            div.className = "incident";
            div.id = `incident-${post.id}`;
            div.innerHTML = `
                <h3>${post.title.rendered}</h3>
                <p>${description}</p>
                ${img ? `<img src="${img}">` : ""}

                <div class="incident-actions">
                    <span class="edit-icon" onclick="editIncident(${post.id})">‚úèÔ∏è</span>
                    <span class="delete-icon" onclick="deleteIncident(${post.id})">üóëÔ∏è</span>
                </div>
                 ${locationText ? `<span class="location">üìç ${locationText}</span>` : ''}

            `;
            list.appendChild(div);
        });

    } catch (err) {
        console.error(err);
        alert("Failed to load incidents: " + err.message);
    }
}

// Filter change listener
document.getElementById("category").addEventListener("change", loadIncidents);

// Initial load
loadIncidents();

</script>

</body>
</html>
